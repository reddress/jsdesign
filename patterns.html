  <!DOCTYPE html>
  <html>
  <head>
  <meta charset="utf-8">
  <title>My JS Design Patterns</title>
  </head>
  <body>
  <script>

function out() {
  console.log.apply(console, arguments);
}

// out("hello", "world", 2);

// SECTION
// THE CONSTRUCTOR PATTERN

function runConstructorPattern() {
  var newObject = {};
  var newObject = Object.create(Object.prototype);
  var newObject = new Object();

  // SETTING PROPERTIES (KEYS AND VALUES)
  newObject.someKey = "Hello";
  var value = newObject.someKey;

  newObject["someKey"] = "Hello";
  var value = newObject["someKey"];

  // MORE CONTROL OVER PROPERTY'S BEHAVIOR
  Object.defineProperty(newObject, "someKey", {
    value: "Hello",
    writable: true,
    enumerable: true,
    configurable: true
  });

  // DEFINE PROPERTIES WITH DEFAULT OPTIONS
  var defineProp = function(obj, key, value) {
    var config = {
      value: value,
      writable: true,
      enumerable: true,
      configurable: true
    };
    Object.defineProperty(obj, key, config);
  };

  var person = Object.create(Object.prototype);

  defineProp(person, "car", "DeLorean");
  defineProp(person, "dateOfBirth", "1981");
  defineProp(person, "hasBeard", false);

  out(person);

  Object.defineProperties(newObject, {
    "someKey": {
      value: "Hello",
      writable: true
    },
    "anotherKey": {
      value: "Goodbye",
      writable: false
    }
  });

  // SIMPLE INHERITANCE
  // A race car driver
  var driver = Object.create(person);
  defineProp(driver, "topSpeed", "100 mph");
  out(driver.dateOfBirth);

  // SUBSECTION
  // BASIC CONSTRUCTORS

  // Prefixing a function call with "new" calls constructor behavior
  // "this" references the new object being created

  function Car(model, year, miles) {
    this.model = model;
    this.year = year;
    this.miles = miles;

    this.toString = function() {
      return this.model + " has done " + this.miles + " miles";
    };
  }

  var civic = new Car("Honda Civic", 2009, 20000);
  out(civic.toString());

  // PROBLEM: toString() IS REDEFINED FOR EACH OF THE NEW OBJECTS

  // SUBSECTION
  // CONSTRUCTORS WITH PROTOTYPES
  function CarWithProto(model, year, miles) {
    this.model = model;
    this.year = year;
    this.miles = miles;
  }

  CarWithProto.prototype.toString = function() {
    return this.model + " has done " + this.miles + " miles";
  };

  var mondeo = new CarWithProto("Ford Mondeo", 2010, 5000);
  out(mondeo.toString());
}


// SECTION
// OBJECT LITERALS

function runModulePattern() {
  var variableValue = 'Hello';

  var myObjectLiteral = {
    variableKey: variableValue,
    functionKey: function() {
      return 0;
    }
  };

  var myModule = {
    myProperty: "someValue",

    myConfig: {
      useCaching: true,
      language: 'en'
    },

    saySomething: function() {
      out("where is Paul Irish?");
    },

    reportMyConfig: function() {
      out("Caching is " + this.myConfig.useCaching);
    },

    updateMyConfig: function(newConfig) {
      if (typeof newConfig === 'object') {
        this.myConfig = newConfig;
        out(this.myConfig.language);
      }
    }
  };

  myModule.reportMyConfig();
  myModule.updateMyConfig({
    language: 'fr',
    useCaching: false
  });
  myModule.reportMyConfig();

  // SUBSECTION
  // MODULE PATTERN

  var testModule = (function() {
    var counter = 0;

    return {
      incrementCounter: function() {
        return counter++;
      },
      resetCounter: function() {
        out("counter value prior to reset: " + counter);
        counter = 0;
      }
    };
  })();

  testModule.incrementCounter();
  testModule.incrementCounter();
  testModule.resetCounter();
  testModule.incrementCounter();
  testModule.resetCounter();

  // NAMESPACING
  var myNamespace = (function() {
    var myPrivateVar, myPrivateMethod;
    myPrivateVar = 0;
    myPrivateMethod = function(foo) {
      out("the private method says " + foo);
    };

    return {
      myPublicVar: 'the public value',
      myPublicFunction: function(bar) {
        myPrivateVar++;
        myPrivateMethod(bar);
      }
    };
  })();

  myNamespace.myPublicFunction("Hi");

  var basketModule = (function() {
    // private
    var basket = [];

    function doSomethingPrivate() {
      
    }

    return {
      addItem: function(values) {
        basket.push(values);
      },

      getItemCount: function() {
        return basket.length;
      },

      doSomething: doSomethingPrivate,

      getTotal: function() {
        var q = this.getItemCount();
        var p = 0;

        while (q--) {
          p += basket[q].price;
        }
        return p;
      }
    };
  })();

  basketModule.addItem({
    item: "soda",
    price: 3.50
  });

  basketModule.addItem({
    item: "eggs",
    price: 2.25
  });
  out(basketModule.getTotal());

  // IMPORT MIXINS
  
  // Global module importing jQuery and Underscore
  var myModule = (function(jQ, _) {
    function privateMethod() {
      jQ(".container").html("test");
    }

    return {
      publicMethod: function() {
        privateMethod();
      }
    };
  })(jQuery, _);

  // EXPORTS

  // Global module
  var myModule = (function() {
    var module = {};
    var privateVariable = "Hello";

    function privateMethod() {

    }

    module.publicProperty = "Foo";
    module.publicMethod = function() {
      out(privateVariable);
    };

    return module;
  })();

  // SKIPPED: Module pattern with Dojo, ExtJS, YUI, and jQuery
}

// SECTION
// REVEALING MODULE PATTERN
// define all variables and functions in the private scope, then return
// an anonymous object with pointers to parts desired to be made public

function runRevealingModulePattern() {
  var myRevealingModule = (function() {
    var privateVar = "Ben Cherry";
    var publicVar = "Hey there";

    function privateFunction() {
      out("name: " + privateVar);
    }

    function publicSetName(strName) {
      privateVar = strName;
    }

    function publicGetName() {
      privateFunction();
    }

    return {
      setName: publicSetName,
      greeting: publicVar,
      getName: publicGetName
    };
  })();

  myRevealingModule.setName("Jet Star");
  myRevealingModule.getName();
  out(myRevealingModule.greeting);
}

// SECTION
// SINGLETON PATTERN
// a shared resource namespace which isolate implementation code from the
// global namespace
function runSingletonPattern() {
  var mySingleton = (function() {
    var instance;

    function init() {
      function privateMethod() {
        out("private method called");
      }

      var privateVariable = "A private variable";

      var privateRandomNumber = Math.random();

      return {
        publicMethod: function() {
          out("Public can see me");
        },
        publicProperty: "Also public",
        getRandomNumber: function() {
          return privateRandomNumber;
        }
      };
    }

    return {
      getInstance: function() {
        if (!instance) {
          instance = init();
        }
        return instance;
      }
    };
  })();

  var singleA = mySingleton.getInstance();
  var singleB = mySingleton.getInstance();
  out(singleA.getRandomNumber());
  out(singleB.getRandomNumber());

  var SingletonTester = (function() {
    function Singleton(options) {
      options = options || {};
      this.name = "Singleton Tester";
      this.pointX = options.pointX || 6;
      this.pointY = options.pointY || 10;
    }

    var instance;
    var _static = {
      name: "Singleton Tester _static",
      getInstance: function(options) {
        if (instance === undefined) {
          instance = new Singleton(options);
        }
        return instance;
      }
    };
    return _static;
  })();

  var singletonTest = SingletonTester.getInstance({
    pointX: 5
  });

  out(singletonTest.pointX);
}

// SECTION
// OBSERVER PATTERN
// the subject (an object) maintains a list of objects (observers) that
// depend on it, and automatically notifies them of changes of state

function runObserverPattern() {
  function ObserverList() {
    this.observerList = [];
  }

  ObserverList.prototype.add = function(obj) {
    return this.observerList.push(obj);
  };

  ObserverList.prototype.count = function() {
    return this.observerList.length;
  };

  ObserverList.prototype.get = function(index) {
    if (index > -1 && index < this.observerList.length) {
      return this.observerList[index];
    }
  };

  ObserverList.prototype.indexOf = function(obj, startIndex) {
    var i = startIndex;

    while (i < this.observerList.length) {
      if (this.observerList[i] === obj){
        return i;
      }
      i++;
    }
    return -1;
  };

  ObserverList.prototype.removeAt = function(index) {
    this.observerList.splice(index, 1);
  };

  function Subject() {
    this.observers = new ObserverList();
  }

  Subject.prototype.addObserver = function(observer) {
    this.observers.add(observer);
  };

  Subject.prototype.removeObserver = function(observer) {
    this.observers.removeAt(this.observers.indexOf(observer, 0));
  };

  Subject.prototype.notify = function(context) {
    var observerCount = this.observers.count();
    for (var i = 0; i < observerCount; i++) {
      this.observers.get(i).update(context);
    }
  };

  function Observer() {
    this.update = function() {
      // ...
    };
  }

  // SUBSUBSECTION
  // A PUBLISH/SUBSCRIBE IMPLEMENTATION
  var pubsub = {};

  (function(myObject) {
    // Storage for topics that can be broadcast or listened to
    var topics = {};
    var subUid = -1;
    myObject.publish = function(topic, args) {
      if (!topics[topic]) {
        return false;
      }

      var subscribers = topics[topic];
      var len = subscribers ? subscribers.length : 0;

      while (len--) {
        subscribers[len].func(topic, args);
      }

      return this;
    };

    myObject.subscribe = function(topic, func) {
      if (!topics[topic]) {
        topics[topic] = [];
      }

      var token = (++subUid).toString();
      topics[topic].push({
        token: token,
        func: func
      });
      return token;
    };

    myObject.unsubscribe = function(token) {
      for (var m in topics) {
        if (topics[m]) {
          for (var i = 0, j = topics[m].length; i < j; i++) {
            if (topics[m][i].token === token) {
              topics[m].splice(i, 1);
              return token;
            }
          }
        }
      }
      return this;
    };
  })(pubsub);

  // USING THE PUBSUB IMPLEMENTATION
  var messageLogger = function(topics, data) {
    if (typeof data === "object") {
      out("Logging object " + topics + " " + JSON.stringify(data));
    }
    else {
      out("Logging " + topics + ": " + data);
    }
  };

  var subscription = pubsub.subscribe("inbox/newMessage", messageLogger);

  pubsub.publish("inbox/newMessage", "hello world");
  pubsub.publish("inbox/newMessage", ["a", "b", "c"]);
  pubsub.publish("inbox/newMessage",{
    sender: "me@google.com",
    body: "hey again"
  });

  pubsub.publish("inbox/otherMessage", "hello other world");

  pubsub.unsubscribe(subscription);

  pubsub.publish("inbox/newMessage", "still there?");
}

function runMediatorPattern() {
  var mediator = {};

  var orgChart = {
    addNewEmployee: function() {
      var employeeDetail = this.getEmployeeDetail();

      employeeDetail.on("complete", function(employee) {
        var managerSelector =  this.selectManager(employee);
        managerSelector.on("save", function(employee) {
          employee.save();
        });
      });
    },
    getEmployeeDetail: function() {
      out("View for employee detail");
      return { on: function() { } };
    }
  }
}

function runPrototypePattern() {
  var myCar = {
    name: "Ford Escort",

    drive: function() {
      out("Whee I'm driving");
    },

    panic: function() {
      out("Wait, how do you stop?");
    }
  };

  var yourCar = Object.create(myCar);
  out(yourCar.name);

  var vehicle = {
    getModel: function() {
      out("the model is " + this.model);
    }
  };

  var car = Object.create(vehicle, {
    "id": {
      value: Math.random(),
      enumerable: true
    },
    "model": {
      value: "Ford",
      enumerable: true
    }
  });

  car.getModel();

  // IMPLEMENT PROTOTYPE PATTERN WITHOUT DIRECTLY USING Object.create
  var vehiclePrototype = {
    init: function(carModel) {
      this.model = carModel;
    },
    getModel: function() {
      out("the model is ... " + this.model);
    }
  };

  function vehicleMaker(model) {
    function F() {};
    F.prototype = vehiclePrototype;

    var f = new F();
    f.init(model);
    return f;
  }

  var car = vehicleMaker("Mazda M60");
  car.getModel();

  // returns a function accepting a prototype, which returns a new F with
  // the given prototype
  var beget = (function () {
    function F() {};
    return function(proto) {
      F.prototype = proto;
      return new F();
    };
  })();

  out(beget());
  out(beget(vehicle));
}

function runCommandPattern() {
  var carManager = {
    requestInfo: function(model) {
      return "the info for " + model;
    },
    buyVehicle: function(model) {
      return "purchased " + model;
    },
    arrangeViewing: function(model) {
      return "booked viewing of " + model;
    },
  };

  carManager.execute = function(name) {
    return carManager[name] && carManager[name].apply(carManager, [].slice.call(arguments, 1));
  };

  out(carManager.execute("requestInfo", "Mondeo"));
}

function runFacadePattern() {
  var module = (function() {
    var _private = {
      i: 5,
      get: function() {
        out("current value: " + this.i);
      },
      set: function(val) {
        this.i = val;
      },
      run: function() {
        out("running");
      },
    };

    return {
      facade: function(args) {
        _private.set(args.val);
        _private.get();
        if (args.run) {
          _private.run();
        }
      }
    };
  }());

  module.facade({run: true, val: 10});
}

function runFactoryPattern() {
  function Car(options) {
    this.doors = options.doors || 4;
    this.state = options.state || "brand new";
    this.color = options.color || "silver";
  }
  Car.prototype.drive = "up to 100 mph";
  Car.prototype.breakDown = "call for help";

  function Truck(options) {
    this.state = options.state || "used";
    this.wheelSize = options.wheelSize || "large";
    this.color = options.color || "blue";
  }

  // skeleton factory
  function VehicleFactory() {}
  
  VehicleFactory.prototype.vehicleClass = Car;
  VehicleFactory.prototype.createVehicle = function(options) {
    switch(options.vehicleType) {
    case "car":
      this.vehicleClass = Car;
      break;
    case "truck":
      this.vehicleClass = Truck;
      break;
    }
    return new this.vehicleClass(options);
  };

  var carFactory = new VehicleFactory();
  var car = carFactory.createVehicle({
    vehicleType: "car",
    color: "yellow",
    doors: 6});

  out(car);

  // subclass VehicleFactory to create TruckFactory
  function TruckFactory() {}
  TruckFactory.prototype = new VehicleFactory();
  TruckFactory.prototype.vehicleClass = Truck;

  var truckFactory = new TruckFactory();
  var myBigTruck = truckFactory.createVehicle({
    state: "so bad",
    color: "pink",
    wheelSize: "so big"});

  out(myBigTruck instanceof Truck);

  var abstractVehicleFactory = (function() {
    var types = {};

    return {
      getVehicle: function(type, customizations) {
        var Vehicle = types[type];
        return (Vehicle ? new Vehicle(customizations) : null);
      },

      registerVehicle: function(type, Vehicle) {
        var proto = Vehicle.prototype;
        if (proto.drive && proto.breakDown) {
          types[type] = Vehicle;
        }
        return abstractVehicleFactory;
      }
    };
  })();

  abstractVehicleFactory.registerVehicle("car", Car);
  abstractVehicleFactory.registerVehicle("truck", Truck);

  var car = abstractVehicleFactory.getVehicle("car", {
    color: "green",
    state: "like new"});

  out(car);
}


// RUN INDIVIDUAL PATTERNS
// runConstructorPattern();
// runModulePattern();
// runRevealingModulePattern();
// runSingletonPattern();
// runObserverPattern();
// runMediatorPattern();
// runPrototypePattern();
// runCommandPattern();
// runFacadePattern();
runFactoryPattern();

</script>
  </body>
  </html>
